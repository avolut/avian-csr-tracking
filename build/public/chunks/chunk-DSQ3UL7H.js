import{d as C}from"./chunk-55V4HHK3.js";import{u as _}from"./chunk-FTDH4D5C.js";import{a as S}from"./chunk-SR5OL73C.js";import{a as T}from"./chunk-WJABE3AS.js";import{a as L}from"./chunk-ZUGU5IHP.js";import{b as P,e as g}from"./chunk-NXH6K27G.js";import{a as I}from"./chunk-2OZ4JKVY.js";import{b as O}from"./chunk-IRKXFVRU.js";import{a as b,e as u}from"./chunk-SDY2POXP.js";var p=u(I());var x=u(P()),y=u(T()),v=u(S()),f=u(O());var E=b(t=>{let l=L(),a=(0,f.useRef)({silentLoading:!1,loading:!1,rawItems:[],items:[],params:null,value:0,labelLoaded:!1,async queryLabel(){if(!a.labelLoaded&&(a.value=(0,y.default)(e.db.data,r),!(0,x.default)(a.items,{value:a.value})&&!a.loading&&!!a.value&&d)){let s=(0,y.default)(e,`__belongsToLabelCache.${o}.${i}.${a.value}`);if(s){a.items=[...a.items,{value:a.value,label:s}];return}if(!a.loading){a.loading=!0,l();let c=e.config.alter[t.name],w=(await g[d.modelClass].findMany({where:{[i]:a.value}})).map(q=>$({e:q,alter:c,to:i}));a.items=[...a.items,w[0]],(0,v.default)(e,`__belongsToLabelCache.${o}.${i}.${a.value}`,w[0].label),a.loading=!1,l(),setTimeout(()=>{a.labelLoaded=!0},500)}}},getParams(){let n={},s=e.config.alter[t.name];return s&&(typeof s.params=="function"?n=s.params(e.db.data):typeof s.params=="object"&&(n={...s.params})),n},async query(){if(d){a.value=e.db.data[r];let n=e.config.alter[t.name];a.loading=!0,l(),a.rawItems=await g[d.modelClass].findMany(this.params),a.items=a.rawItems.map(s=>{let c=$({e:s,alter:n,to:i});return s[i]===a.value&&(0,v.default)(e,`__belongsToLabelCache.${o}.${i}.${a.value}`,c.label),c}),a.loading=!1,l()}}}).current,e=(0,f.useContext)(t.ctx),o=(t.name.indexOf(".")>0?t.name.split(".").shift():t.name)||t.name,d=e.db.definition?.rels[o],i=d?.join.to.split(".").pop()||"",r=d?.join.from.split(".").pop()||"",m=(e.config.fields[t.name]||{}).state;return(0,f.useEffect)(()=>{a.queryLabel(),a.silentLoading=!0;let n=a.getParams();_(n,JSON.stringify(a.params))||(a.params=n,a.query())},[]),e.db.data[o]&&e.db.data[o][i]!==e.db.data[r]&&(e.db.data[r]=e.db.data[o][i]),e.db.data[o]||(e.db.data[r]=e.db.data[o]),e.db.data[r]!==a.value&&(a.value=e.db.data[r]),(0,p.jsx)(React.Fragment,null,(0,p.jsx)(C,{onChange:n=>{if(m.value||(m.value={}),typeof m.onChange=="function"&&m.onChange(n,{state:e,row:e.db.data,col:t.name}),typeof e.db.data[o]=="object")for(let s of a.rawItems)s[i]===n&&(e.db.data[o]=s);e.db.data[r]=n,a.value=n,t.internalChange(n)},loading:!a.silentLoading&&!!(a.loading||!m),onDropDown:()=>{a.silentLoading=!1;let n=a.getParams();JSON.stringify(n)!==JSON.stringify(a.params)&&(a.params=n,a.query())},value:a.value,items:a.items}))},"WBelongsTo"),$=b(({e:t,alter:l,to:h})=>{let a=t.name||t.nama||t.value||t.text||"";if(!a){for(let[e,o]of Object.entries(t))if(e.indexOf("_id")<0&&e.indexOf("id_")<0&&e!=="id"){typeof o=="string"&&(a=o);break}}return l&&l.label&&(a=l.label(t)),{value:t[h],label:a}},"labelText");export{E as a,$ as b};
//# sourceMappingURL=chunk-DSQ3UL7H.js.map
