{
  "version": 3,
  "sources": ["../../../pkgs/web/crud/src/form/web/fields/WBelongsTo.tsx"],
  "sourcesContent": ["/** @jsx jsx */\nimport { jsx } from '@emotion/react'\nimport { db } from 'libs'\nimport find from 'lodash.find'\nimport get from 'lodash.get'\nimport set from 'lodash.set'\nimport { useContext, useEffect, useRef } from 'react'\nimport { fastDeepEqual } from 'web-utils/src/fastDeepEqual'\nimport { useRender } from 'web-utils/src/useRender'\nimport { IBaseFieldProps } from '../../../../../ext/types/__form'\nimport { PureSelect } from './WSelect'\n\nexport const WBelongsTo = (props: IBaseFieldProps) => {\n  const render = useRender()\n  const _ = useRef({\n    silentLoading: false,\n    loading: false,\n    rawItems: [] as any,\n    items: [] as any,\n    params: null as any,\n    value: 0 as any,\n    labelLoaded: false,\n    async queryLabel() {\n      if (!meta.labelLoaded) {\n        meta.value = get(form.db.data, from)\n        const found = find(meta.items, { value: meta.value })\n\n        if (!found && !meta.loading && !!meta.value && rel) {\n          const cache = get(\n            form,\n            `__belongsToLabelCache.${relName}.${to}.${meta.value}`\n          )\n\n          if (cache) {\n            meta.items = [...meta.items, { value: meta.value, label: cache }]\n            return\n          }\n\n          if (!meta.loading) {\n            meta.loading = true\n            render()\n            const alter = form.config.alter[props.name] as any\n\n            const res = (\n              await db[rel.modelClass].findMany({\n                where: {\n                  [to]: meta.value,\n                },\n              })\n            ).map((e) => {\n              return labelText({ e, alter, to })\n            })\n            meta.items = [...meta.items, res[0]]\n            set(\n              form,\n              `__belongsToLabelCache.${relName}.${to}.${meta.value}`,\n              res[0].label\n            )\n\n            meta.loading = false\n            render()\n\n            setTimeout(() => {\n              meta.labelLoaded = true\n            }, 500)\n          }\n        }\n      }\n    },\n    getParams() {\n      let params = {}\n      const alter = form.config.alter[props.name] as any\n      if (alter) {\n        if (typeof alter.params === 'function') {\n          params = alter.params(form.db.data)\n        } else if (typeof alter.params === 'object') {\n          params = { ...alter.params }\n        }\n      }\n      return params\n    },\n    async query() {\n      if (rel) {\n        meta.value = form.db.data[from]\n        const alter = form.config.alter[props.name] as any\n\n        meta.loading = true\n        render()\n        meta.rawItems = await db[rel.modelClass].findMany(this.params)\n        meta.items = meta.rawItems.map((e) => {\n          const res = labelText({ e, alter, to })\n          if (e[to] === meta.value) {\n            set(\n              form,\n              `__belongsToLabelCache.${relName}.${to}.${meta.value}`,\n              res.label\n            )\n          }\n          return res\n        })\n        meta.loading = false\n        render()\n      }\n    },\n  })\n  const meta = _.current\n  const form = useContext(props.ctx)\n  const relName =\n    (props.name.indexOf('.') > 0\n      ? props.name.split('.').shift()\n      : props.name) || props.name\n\n  const rel = form.db.definition?.rels[relName]\n  const to = rel?.join.to.split('.').pop() || ''\n  const from = rel?.join.from.split('.').pop() || ''\n  const state = (form.config.fields[props.name] || {}).state\n\n  useEffect(() => {\n    meta.queryLabel()\n\n    meta.silentLoading = true\n    const params = meta.getParams()\n    if (!fastDeepEqual(params, JSON.stringify(meta.params))) {\n      meta.params = params\n      meta.query()\n    }\n  }, [])\n\n  if (\n    form.db.data[relName] &&\n    form.db.data[relName][to] !== form.db.data[from]\n  ) {\n    form.db.data[from] = form.db.data[relName][to]\n  }\n\n  if (!form.db.data[relName]) {\n    form.db.data[from] = form.db.data[relName]\n  }\n\n  if (form.db.data[from] !== meta.value) {\n    meta.value = form.db.data[from]\n  }\n\n  return (\n    <>\n      <PureSelect\n        onChange={(value) => {\n          if (!state.value) {\n            state.value = {}\n          }\n\n          if (typeof state.onChange === 'function')\n            state.onChange(value, {\n              state: form,\n              row: form.db.data,\n              col: props.name,\n            })\n\n          if (typeof form.db.data[relName] === 'object') {\n            for (let row of meta.rawItems) {\n              if (row[to] === value) {\n                form.db.data[relName] = row\n              }\n            }\n          }\n          form.db.data[from] = value\n          meta.value = value\n          props.internalChange(value)\n        }}\n        loading={!meta.silentLoading && !!(meta.loading || !state)}\n        onDropDown={() => {\n          meta.silentLoading = false\n          const params = meta.getParams()\n          if (JSON.stringify(params) !== JSON.stringify(meta.params)) {\n            meta.params = params\n            meta.query()\n          }\n        }}\n        value={meta.value}\n        items={meta.items}\n      />\n    </>\n  )\n}\n\nexport const labelText = ({ e, alter, to }) => {\n  let label = e.name || e.nama || e.value || e.text || ''\n\n  if (!label) {\n    for (let [k, v] of Object.entries(e)) {\n      if (k.indexOf('_id') < 0 && k.indexOf('id_') < 0 && k !== 'id') {\n        if (typeof v === 'string') {\n          label = v\n        }\n        break\n      }\n    }\n  }\n\n  if (alter && alter.label) {\n    label = alter.label(e)\n  }\n\n  return {\n    value: e[to],\n    label,\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
