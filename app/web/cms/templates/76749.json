{"content":{"type":"API","structure":"","server_on_load":"async ({\n  template,\n  params,\n  render,\n  db,\n  req,\n  reply,\n  user,\n  log,\n  ext,\n  isDev,\n}: Server) => {\n  const role = req.body.role;\n  let password = req.body.password;\n\n  let login;\n  let userFound;\n\n  const checkUserFound = (login) => {\n    if (login === undefined || login === null) return false;\n    return true;\n  };\n\n  const checkPasswordMatch = async (passwordHash, password) => {\n    try {\n      if (await ext.argon2.verify(passwordHash, password)) return true;\n      else return false;\n    } catch (err) {\n      console.error(err);\n    }\n\n    return false;\n  };\n\n  if (role === \"admin\") {\n    login = await db.m_user.findFirst({\n      where: { username: req.body.username },\n    });\n    userFound = checkUserFound(login);\n    password = req.body.password;\n  }\n\n  if (userFound) {\n    const passwordMatch = await checkPasswordMatch(login.password, password);\n    if (!passwordMatch)\n      return reply.send({\n        status: \"failed\",\n        msg: \"Username or password wrong!\",\n      });\n  } else {\n    return reply.send({\n      status: \"failed\",\n      msg: \"User not found\",\n    });\n  }\n\n  const data = { role: role, ...login };\n  req.session.user = data;\n  req.session.role = role;\n\n  reply.send({\n    status: \"success\",\n    user: data,\n  })\n}","figma":{}},"title":"login","type":"cms-template","lang":"","status":"SYSTEM","parent_id":"04162","slug":"/api/login","site":"*","id":"76749"}